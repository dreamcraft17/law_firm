// Prisma schema â€” satu DB untuk admin-web + mobile (law_firm Flutter)
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- R0: RBAC ---
model Role {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(128)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// --- Session for token validation (admin + mobile) ---
model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  source    String   @default("mobile") @db.VarChar(32)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// --- Base (auth + cases) ---
model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @db.VarChar(255)
  name         String?   @db.VarChar(255)
  role         String    @default("staff") @db.VarChar(64)
  roleId       String?   @map("role_id") @db.Uuid
  clientId     String?   @map("client_id") @db.Uuid
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  roleRef     Role?     @relation(fields: [roleId], references: [id])
  clientRef   Client?   @relation(fields: [clientId], references: [id])
  lawyerMetrics LawyerPerformanceMetric[]
  timeEntries   TimeEntry[]
  rateCards     RateCard[]
  caseTeams     CaseTeamMember[]
  sessions      Session[]

  @@map("users")
}

// --- M1: Client Management ---
model Client {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type          String    @default("individual") @db.VarChar(32) // individual | company
  name          String    @db.VarChar(500)
  billingAddress String?  @map("billing_address") @db.Text
  npwp          String?   @db.VarChar(64)
  status        String    @default("active") @db.VarChar(32) // active | inactive
  internalNotes String?   @map("internal_notes") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  contacts   ClientContact[]
  cases      Case[]
  invoices   Invoice[]
  users      User[]

  @@map("clients")
}

model ClientContact {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  name      String   @db.VarChar(255)
  email     String?  @db.VarChar(255)
  phone     String?  @db.VarChar(64)
  role      String?  @db.VarChar(64) // e.g. PIC, Direktur
  isPrimary Boolean  @default(false) @map("is_primary") @db.Boolean
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  client Client @relation(fields: [clientId], references: [id])

  @@map("client_contacts")
}

model Case {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String   @db.VarChar(500)
  caseNumber  String?  @map("case_number") @db.VarChar(100)
  description String?  @db.Text
  status      String   @default("pending") @db.VarChar(64)
  stage       String   @default("intake") @db.VarChar(32) // intake | active | on_hold | closed
  clientId    String?  @map("client_id") @db.Uuid
  parties     Json?    @db.JsonB // { plaintiff?, defendant?, instansi? }
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  client       Client?           @relation(fields: [clientId], references: [id])
  riskScores   CaseRiskScore[]
  timeEntries  TimeEntry[]
  expenses     CaseExpense[]
  tasks        Task[]
  documents    Document[]
  teamMembers  CaseTeamMember[]

  @@map("cases")
}

model CaseTeamMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId    String   @map("case_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String?  @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([caseId, userId])
  @@map("case_team_members")
}

// --- Mobile: tasks, documents, events, invoices, notifications ---
model Task {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId      String?   @map("case_id") @db.Uuid
  title       String    @db.VarChar(500)
  description String?   @db.Text
  status      String    @default("pending") @db.VarChar(64)
  dueDate     DateTime? @map("due_date") @db.Timestamptz(6)
  slaBreachAt DateTime? @map("sla_breach_at") @db.Timestamptz(6)
  assigneeId  String?   @map("assignee_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  case Case? @relation(fields: [caseId], references: [id])
  timeEntries TimeEntry[]

  @@map("tasks")
}

model Document {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId        String?  @map("case_id") @db.Uuid
  name          String   @db.VarChar(500)
  folder        String?  @db.VarChar(255)
  version       Int      @default(1) @db.SmallInt
  clientVisible Boolean  @default(false) @map("client_visible") @db.Boolean
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  case Case? @relation(fields: [caseId], references: [id])

  @@map("documents")
}

model Event {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title     String   @db.VarChar(500)
  startAt   DateTime @map("start_at") @db.Timestamptz(6)
  endAt     DateTime? @map("end_at") @db.Timestamptz(6)
  type      String?  @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("events")
}

model Invoice {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber String?   @unique @map("invoice_number") @db.VarChar(64)
  status        String    @default("draft") @db.VarChar(32) // draft | sent | partial_paid | paid | overdue | void
  amount        Decimal   @default(0) @db.Decimal(18, 2)
  paidAmount    Decimal   @default(0) @map("paid_amount") @db.Decimal(18, 2)
  clientId      String?   @map("client_id") @db.Uuid
  dueDate       DateTime? @map("due_date") @db.Date
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  client   Client?       @relation(fields: [clientId], references: [id])
  expenses CaseExpense[]

  @@map("invoices")
}

// --- M2: Time Tracking ---
model TimeEntry {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId     String    @map("case_id") @db.Uuid
  taskId     String?   @map("task_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  description String?  @db.Text
  hours      Decimal   @db.Decimal(6, 2)
  billable   Boolean   @default(true) @db.Boolean
  rate       Decimal?  @db.Decimal(18, 2)
  approvedAt DateTime? @map("approved_at") @db.Timestamptz(6)
  workDate   DateTime  @map("work_date") @db.Date
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)

  case Case  @relation(fields: [caseId], references: [id])
  task Task? @relation(fields: [taskId], references: [id])
  user User  @relation(fields: [userId], references: [id])

  @@map("time_entries")
}

model RateCard {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  rate         Decimal   @db.Decimal(18, 2)
  effectiveFrom DateTime @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@map("rate_cards")
}

// --- M3: Expense per Case ---
model CaseExpense {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId       String    @map("case_id") @db.Uuid
  description  String    @db.VarChar(500)
  amount       Decimal   @db.Decimal(18, 2)
  proofUrl     String?   @map("proof_url") @db.VarChar(500)
  reimbursable Boolean   @default(false) @db.Boolean
  approvedAt   DateTime? @map("approved_at") @db.Timestamptz(6)
  invoiceId    String?   @map("invoice_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  case    Case     @relation(fields: [caseId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("case_expenses")
}

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  title     String    @db.VarChar(500)
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("notifications")
}

// --- Web-only tables ---
model SystemSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(128)
  value       Json?    @db.JsonB
  category    String   @db.VarChar(64)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("system_settings")
}

model WorkflowTemplate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(128)
  caseType  String?  @map("case_type") @db.VarChar(64)
  steps     Json     @default("[]") @db.JsonB
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("workflow_templates")
}

model RetentionPolicy {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @db.VarChar(255)
  documentType String?  @map("document_type") @db.VarChar(64)
  caseStatus   String?  @map("case_status") @db.VarChar(64)
  retainYears  Int      @map("retain_years")
  actionAfter  String   @map("action_after") @db.VarChar(32)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("retention_policies")
}

model CustomField {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entity     String   @db.VarChar(64)
  caseType   String?  @map("case_type") @db.VarChar(64)
  fieldKey   String   @map("field_key") @db.VarChar(128)
  label      String   @db.VarChar(255)
  fieldType  String   @map("field_type") @db.VarChar(32)
  options    Json?    @db.JsonB
  isRequired Boolean  @default(false) @map("is_required")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("custom_fields")
}

model CaseRiskScore {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId      String   @map("case_id") @db.Uuid
  score       Decimal  @db.Decimal(5, 2)
  factors     Json?    @db.JsonB
  calculatedAt DateTime @default(now()) @map("calculated_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  case Case @relation(fields: [caseId], references: [id])

  @@map("case_risk_scores")
}

model LawyerPerformanceMetric {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String   @map("user_id") @db.Uuid
  periodType           String   @map("period_type") @db.VarChar(16)
  periodStart          DateTime @map("period_start") @db.Date
  periodEnd            DateTime @map("period_end") @db.Date
  casesClosed          Int      @default(0) @map("cases_closed")
  revenueBilled        Decimal  @default(0) @map("revenue_billed") @db.Decimal(18, 2)
  revenueCollected     Decimal  @default(0) @map("revenue_collected") @db.Decimal(18, 2)
  utilizationPct       Decimal? @map("utilization_pct") @db.Decimal(5, 2)
  avgCaseDurationDays  Int?     @map("avg_case_duration_days")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, periodType, periodStart])
  @@map("lawyer_performance_metrics")
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  action    String   @db.VarChar(64)
  entity    String   @db.VarChar(64)
  entityId  String?  @map("entity_id") @db.Uuid
  details   Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("audit_logs")
}
