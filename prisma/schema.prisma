// Prisma schema — satu DB untuk admin-web + mobile (law_firm Flutter)
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enterprise: Multi-tenant (Firm isolation) ---
model Firm {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String    @db.VarChar(255)
  slug      String    @unique @db.VarChar(64)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  users       User[]
  clients     Client[]
  cases       Case[]
  configs     FirmConfig[]
  numberSeqs  NumberSequence[]
  exportJobs  ExportJob[]
  roles       Role[]

  @@map("firms")
}

model FirmConfig {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  key       String   @db.VarChar(128) // branding_logo_url | case_number_prefix | invoice_number_prefix | default_tax_rate | payment_gateway | etc
  value     Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  firm Firm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, key])
  @@map("firm_configs")
}

model NumberSequence {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId     String   @map("firm_id") @db.Uuid
  entityType String   @map("entity_type") @db.VarChar(32) // case | invoice
  scopeKey   String   @map("scope_key") @db.VarChar(64)   // e.g. 2025 | 2025-LITIGATION
  lastValue  Int      @default(0) @map("last_value") @db.Integer
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  firm Firm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, entityType, scopeKey])
  @@map("number_sequences")
}

model ExportJob {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId      String    @map("firm_id") @db.Uuid
  requestedBy String    @map("requested_by") @db.Uuid
  exportType  String    @map("export_type") @db.VarChar(32) // full | gdpr | case
  entityId    String?   @map("entity_id") @db.Uuid
  status      String    @default("pending") @db.VarChar(32) // pending | processing | completed | failed
  fileUrl     String?   @map("file_url") @db.VarChar(2048)
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)

  firm Firm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@map("export_jobs")
}

// --- R0: RBAC ---
model Role {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId    String?   @map("firm_id") @db.Uuid
  name      String   @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  firm        Firm?   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  users       User[]
  permissions RolePermission[]

  @@unique([firmId, name])
  @@map("roles")
}

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(128)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// --- Session for token validation (admin + mobile) — device list & revoke ---
model Session {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  token        String    @unique @db.VarChar(255)
  refreshToken String?   @map("refresh_token") @db.VarChar(255)
  source       String    @default("mobile") @db.VarChar(32)
  userAgent    String?   @map("user_agent") @db.VarChar(500)
  deviceId     String?   @map("device_id") @db.VarChar(255)
  deviceLabel  String?   @map("device_label") @db.VarChar(255)
  ipAddress    String?   @map("ip_address") @db.VarChar(64)
  lastActiveAt DateTime? @map("last_active_at") @db.Timestamptz(6)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// --- Base (auth + cases) — 2FA (TOTP) ---
model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId       String?   @map("firm_id") @db.Uuid
  email        String    @db.VarChar(255)
  name         String?   @db.VarChar(255)
  role         String    @default("staff") @db.VarChar(64)
  roleId       String?   @map("role_id") @db.Uuid
  clientId     String?   @map("client_id") @db.Uuid
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  totpSecret   String?   @map("totp_secret") @db.VarChar(255)
  totpEnabled  Boolean   @default(false) @map("totp_enabled") @db.Boolean
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  firm                 Firm?       @relation(fields: [firmId], references: [id], onDelete: SetNull)
  roleRef              Role?       @relation(fields: [roleId], references: [id])
  clientRef            Client?     @relation(fields: [clientId], references: [id])
  lawyerMetrics        LawyerPerformanceMetric[]
  timeEntries          TimeEntry[]
  rateCards            RateCard[]
  caseTeams            CaseTeamMember[]
  caseAccessList       CaseAccess[]
  sessions             Session[]
  caseMessages         CaseMessage[]
  notificationPrefs    UserNotificationPref?
  documentsCheckedOut  Document[]  @relation("DocumentCheckedOut")

  @@map("users")
}

// --- M1: Client Management ---
model Client {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId        String?   @map("firm_id") @db.Uuid
  type          String    @default("individual") @db.VarChar(32) // individual | company
  name          String    @db.VarChar(500)
  billingAddress String?  @map("billing_address") @db.Text
  npwp          String?   @db.VarChar(64)
  status        String    @default("active") @db.VarChar(32) // active | inactive
  internalNotes String?   @map("internal_notes") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  firm              Firm?   @relation(fields: [firmId], references: [id], onDelete: SetNull)
  contacts         ClientContact[]
  cases            Case[]
  invoices         Invoice[]
  users            User[]
  leads            Lead[]
  approvalRequests ApprovalRequest[]
  trustAccount     ClientTrustAccount?

  @@map("clients")
}

model ClientContact {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  name      String   @db.VarChar(255)
  email     String?  @db.VarChar(255)
  phone     String?  @db.VarChar(64)
  role      String?  @db.VarChar(64) // e.g. PIC, Direktur
  isPrimary Boolean  @default(false) @map("is_primary") @db.Boolean
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  client Client @relation(fields: [clientId], references: [id])

  @@map("client_contacts")
}

model Case {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId      String?  @map("firm_id") @db.Uuid
  title       String   @db.VarChar(500)
  caseNumber  String?  @map("case_number") @db.VarChar(100)
  description String?  @db.Text
  status      String   @default("pending") @db.VarChar(64)
  stage       String   @default("intake") @db.VarChar(32) // intake | active | on_hold | closed
  clientId    String?  @map("client_id") @db.Uuid
  parties     Json?    @db.JsonB // { plaintiff?, defendant?, instansi? }
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  firm              Firm?     @relation(fields: [firmId], references: [id], onDelete: SetNull)
  client            Client?   @relation(fields: [clientId], references: [id])
  riskScores        CaseRiskScore[]
  timeEntries       TimeEntry[]
  expenses          CaseExpense[]
  tasks             Task[]
  documents         Document[]
  teamMembers       CaseTeamMember[]
  caseAccessList    CaseAccess[]
  leads             Lead[]
  caseMessages      CaseMessage[]
  approvalRequests  ApprovalRequest[]
  milestones        CaseMilestone[]
  events            Event[]

  @@map("cases")
}

// --- Enterprise: case-level permission (view / edit / billing / documents) ---
model CaseAccess {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId      String   @map("case_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  canView     Boolean  @default(true) @map("can_view") @db.Boolean
  canEdit     Boolean  @default(false) @map("can_edit") @db.Boolean
  canBilling  Boolean  @default(false) @map("can_billing") @db.Boolean
  canDocuments Boolean @default(false) @map("can_documents") @db.Boolean
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  case_ Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([caseId, userId])
  @@map("case_access")
}

model CaseTeamMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId    String   @map("case_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String?  @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([caseId, userId])
  @@map("case_team_members")
}

// --- Mobile: tasks, documents, events, invoices, notifications ---
model Task {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId                String?   @map("firm_id") @db.Uuid
  caseId                String?   @map("case_id") @db.Uuid
  title                 String    @db.VarChar(500)
  description           String?   @db.Text
  status                String    @default("pending") @db.VarChar(64)
  dueDate               DateTime? @map("due_date") @db.Timestamptz(6)
  slaBreachAt           DateTime? @map("sla_breach_at") @db.Timestamptz(6)
  assigneeId            String?   @map("assignee_id") @db.Uuid
  recurringTemplateId   String?   @map("recurring_template_id") @db.Uuid
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt             DateTime? @map("deleted_at") @db.Timestamptz(6)

  case                  Case?     @relation(fields: [caseId], references: [id])
  timeEntries           TimeEntry[]
  dependsOn             TaskDependency[] @relation("TaskDependsOn")
  dependedOnBy          TaskDependency[] @relation("TaskDependedOnBy")
  recurringTemplate     RecurringTaskTemplate? @relation(fields: [recurringTemplateId], references: [id])
  events                Event[]

  @@map("tasks")
}

model TaskDependency {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taskId         String   @map("task_id") @db.Uuid
  dependsOnTaskId String   @map("depends_on_task_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  task         Task @relation("TaskDependsOn", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOnTask Task @relation("TaskDependedOnBy", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@map("task_dependencies")
}

model CaseMilestone {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId      String   @map("case_id") @db.Uuid
  name        String   @db.VarChar(255)
  dueDate     DateTime? @map("due_date") @db.Date
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  sortOrder   Int      @default(0) @map("sort_order") @db.SmallInt
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_milestones")
}

model RecurringTaskTemplate {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId           String?   @map("firm_id") @db.Uuid
  caseId           String?   @map("case_id") @db.Uuid
  title            String    @db.VarChar(500)
  description      String?   @db.Text
  assigneeId       String?   @map("assignee_id") @db.Uuid
  recurrence       String    @db.VarChar(64) // monthly | quarterly | weekly
  nextRunAt        DateTime  @map("next_run_at") @db.Timestamptz(6)
  lastGeneratedAt  DateTime? @map("last_generated_at") @db.Timestamptz(6)
  isActive         Boolean   @default(true) @map("is_active") @db.Boolean
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime? @map("deleted_at") @db.Timestamptz(6)

  tasks Task[]

  @@map("recurring_task_templates")
}

model Document {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId            String?   @map("firm_id") @db.Uuid
  caseId            String?   @map("case_id") @db.Uuid
  name              String    @db.VarChar(500)
  fileUrl           String?   @map("file_url") @db.VarChar(2048)
  folder            String?   @db.VarChar(255)
  version           Int       @default(1) @db.SmallInt
  clientVisible     Boolean   @default(false) @map("client_visible") @db.Boolean
  checkedOutById    String?   @map("checked_out_by_id") @db.Uuid
  checkedOutAt      DateTime? @map("checked_out_at") @db.Timestamptz(6)
  esignEnvelopeId   String?   @map("esign_envelope_id") @db.VarChar(255)
  esignStatus       String?   @map("esign_status") @db.VarChar(32)
  esignSignedAt     DateTime? @map("esign_signed_at") @db.Timestamptz(6)
  permissionPolicy  Json?     @map("permission_policy") @db.JsonB
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(6)

  case              Case?     @relation(fields: [caseId], references: [id])
  checkedOutByUser  User?     @relation("DocumentCheckedOut", fields: [checkedOutById], references: [id])

  auditLogs DocumentAuditLog[]

  @@map("documents")
}

model DocumentAuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(32)
  meta       Json?    @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_audit_logs")
}

model DocumentTemplate {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId      String?  @map("firm_id") @db.Uuid
  name        String   @db.VarChar(255)
  templateKey String?  @map("template_key") @db.VarChar(128)
  fileUrl     String?  @map("file_url") @db.VarChar(2048)
  mergeFields Json?    @map("merge_fields") @db.JsonB
  category    String?  @db.VarChar(64)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("document_templates")
}

model SavedView {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId     String?  @map("firm_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  name       String   @db.VarChar(255)
  entityType String   @map("entity_type") @db.VarChar(32)
  filters    Json     @db.JsonB
  sortOrder  Int      @default(0) @map("sort_order") @db.SmallInt
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("saved_views")
}

model Event {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId          String?   @map("firm_id") @db.Uuid
  title           String    @db.VarChar(500)
  startAt         DateTime  @map("start_at") @db.Timestamptz(6)
  endAt           DateTime? @map("end_at") @db.Timestamptz(6)
  type            String?   @db.VarChar(64) // consultation | meeting | etc
  leadId          String?   @map("lead_id") @db.Uuid
  caseId          String?   @map("case_id") @db.Uuid
  taskId          String?   @map("task_id") @db.Uuid
  location        String?   @db.VarChar(500)
  reminderMinutes Int?      @map("reminder_minutes") @db.SmallInt
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  lead    Lead?  @relation(fields: [leadId], references: [id])
  case_   Case?  @relation(fields: [caseId], references: [id])
  task    Task?  @relation(fields: [taskId], references: [id])
  attendees EventAttendee[]

  @@map("events")
}

model EventAttendee {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId      String   @map("event_id") @db.Uuid
  attendeeType String   @map("attendee_type") @db.VarChar(32) // user | client_contact
  userId       String?  @map("user_id") @db.Uuid
  clientContactId String? @map("client_contact_id") @db.Uuid
  reminderMinutes Int?   @map("reminder_minutes") @db.SmallInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_attendees")
}

// --- M4: Intake & Lead Management ---
model Lead {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId          String?   @map("firm_id") @db.Uuid
  name            String    @db.VarChar(255)
  email           String?   @db.VarChar(255)
  phone           String?   @db.VarChar(64)
  source          String?   @db.VarChar(64) // referral, website, partner, event
  serviceCategory String?   @map("service_category") @db.VarChar(128)
  problemSummary  String?   @map("problem_summary") @db.Text
  status          String    @default("new") @db.VarChar(32) // new | contacted | qualified | converted | lost
  clientId        String?   @map("client_id") @db.Uuid
  caseId          String?   @map("case_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  client    Client?   @relation(fields: [clientId], references: [id])
  case      Case?     @relation(fields: [caseId], references: [id])
  documents LeadDocument[]
  checklist LeadIntakeChecklist[]
  events    Event[]

  @@map("leads")
}

model LeadDocument {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId    String   @map("lead_id") @db.Uuid
  name      String   @db.VarChar(500)
  fileUrl   String?  @map("file_url") @db.VarChar(2048)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("lead_documents")
}

model LeadIntakeChecklist {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId    String   @map("lead_id") @db.Uuid
  caseId    String?  @map("case_id") @db.Uuid
  itemKey   String   @map("item_key") @db.VarChar(64) // initial_doc, kyc, retainer
  status    String   @default("pending") @db.VarChar(32) // pending | done | verified
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("lead_intake_checklist")
}

model Invoice {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId              String?   @map("firm_id") @db.Uuid
  invoiceNumber       String?   @map("invoice_number") @db.VarChar(64)
  status              String    @default("draft") @db.VarChar(32) // draft | sent | partial_paid | paid | overdue | void
  amount              Decimal   @default(0) @db.Decimal(18, 2)
  paidAmount          Decimal   @default(0) @map("paid_amount") @db.Decimal(18, 2)
  writeOffAmount      Decimal   @default(0) @map("write_off_amount") @db.Decimal(18, 2)
  writeOffReason      String?   @map("write_off_reason") @db.VarChar(255)
  writeOffAt          DateTime? @map("write_off_at") @db.Timestamptz(6)
  taxRate             Decimal?  @map("tax_rate") @db.Decimal(5, 2)
  currency            String    @default("IDR") @db.VarChar(8)
  clientId            String?   @map("client_id") @db.Uuid
  dueDate             DateTime? @map("due_date") @db.Date
  retainerDrawdownAmount Decimal @default(0) @map("retainer_drawdown_amount") @db.Decimal(18, 2)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime? @map("deleted_at") @db.Timestamptz(6)

  client      Client?        @relation(fields: [clientId], references: [id])
  expenses    CaseExpense[]
  creditNotes CreditNote[]
  paymentExports PaymentExport[]

  @@map("invoices")
}

model ClientTrustAccount {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  balance   Decimal  @default(0) @db.Decimal(18, 2)
  currency  String   @default("IDR") @db.VarChar(8)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  client      Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  transactions TrustTransaction[]

  @@unique([clientId])
  @@map("client_trust_accounts")
}

model TrustTransaction {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId   String   @map("account_id") @db.Uuid
  type        String   @db.VarChar(32) // deposit | drawdown | refund | adjustment
  amount      Decimal  @db.Decimal(18, 2)
  referenceId String?  @map("reference_id") @db.Uuid
  note        String?  @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  account ClientTrustAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("trust_transactions")
}

model CreditNote {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId  String   @map("invoice_id") @db.Uuid
  amount     Decimal  @db.Decimal(18, 2)
  reason     String?  @db.VarChar(500)
  status     String   @default("draft") @db.VarChar(32) // draft | applied | void
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("credit_notes")
}

model RateRule {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId        String?   @map("firm_id") @db.Uuid
  caseId        String?   @map("case_id") @db.Uuid
  userId        String?   @map("user_id") @db.Uuid
  activityType  String?   @map("activity_type") @db.VarChar(64)
  rateType      String    @map("rate_type") @db.VarChar(32) // per_case | per_activity | blended | hourly
  rate          Decimal   @db.Decimal(18, 2)
  effectiveFrom DateTime  @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("rate_rules")
}

model PaymentExport {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId  String?  @map("invoice_id") @db.Uuid
  provider   String   @db.VarChar(32) // xero | quickbooks
  externalId String?  @map("external_id") @db.VarChar(255)
  payload    Json?    @db.JsonB
  exportedAt DateTime @default(now()) @map("exported_at") @db.Timestamptz(6)

  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@map("payment_exports")
}

// --- M2: Time Tracking ---
model TimeEntry {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId     String    @map("case_id") @db.Uuid
  taskId     String?   @map("task_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  description String?  @db.Text
  hours      Decimal   @db.Decimal(6, 2)
  billable   Boolean   @default(true) @db.Boolean
  rate       Decimal?  @db.Decimal(18, 2)
  approvedAt DateTime? @map("approved_at") @db.Timestamptz(6)
  workDate   DateTime  @map("work_date") @db.Date
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)

  case Case  @relation(fields: [caseId], references: [id])
  task Task? @relation(fields: [taskId], references: [id])
  user User  @relation(fields: [userId], references: [id])

  @@map("time_entries")
}

model RateCard {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  rate         Decimal   @db.Decimal(18, 2)
  effectiveFrom DateTime @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@map("rate_cards")
}

// --- M3: Expense per Case ---
model CaseExpense {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId       String    @map("case_id") @db.Uuid
  description  String    @db.VarChar(500)
  amount       Decimal   @db.Decimal(18, 2)
  proofUrl     String?   @map("proof_url") @db.VarChar(500)
  reimbursable Boolean   @default(false) @db.Boolean
  approvedAt   DateTime? @map("approved_at") @db.Timestamptz(6)
  invoiceId    String?   @map("invoice_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  case    Case     @relation(fields: [caseId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("case_expenses")
}

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  title     String    @db.VarChar(500)
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("notifications")
}

// --- Web-only tables ---
model SystemSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(128)
  value       Json?    @db.JsonB
  category    String   @db.VarChar(64)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("system_settings")
}

model WorkflowTemplate {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId    String?   @map("firm_id") @db.Uuid
  name      String    @db.VarChar(255)
  slug      String    @db.VarChar(128)
  caseType  String?   @map("case_type") @db.VarChar(64)
  steps     Json      @default("[]") @db.JsonB
  isActive  Boolean   @default(true) @map("is_active") @db.Boolean
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@unique([firmId, slug])
  @@map("workflow_templates")
}

model RetentionPolicy {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId       String?   @map("firm_id") @db.Uuid
  name         String    @db.VarChar(255)
  documentType String?   @map("document_type") @db.VarChar(64)
  caseStatus   String?   @map("case_status") @db.VarChar(64)
  retainYears  Int       @map("retain_years") @db.SmallInt
  actionAfter  String    @map("action_after") @db.VarChar(32)
  isActive     Boolean   @default(true) @map("is_active") @db.Boolean
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("retention_policies")
}

model CustomField {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId     String?   @map("firm_id") @db.Uuid
  entity     String    @db.VarChar(64)
  caseType   String?   @map("case_type") @db.VarChar(64)
  fieldKey   String    @map("field_key") @db.VarChar(128)
  label      String    @db.VarChar(255)
  fieldType  String    @map("field_type") @db.VarChar(32)
  options    Json?     @db.JsonB
  isRequired Boolean   @default(false) @map("is_required") @db.Boolean
  sortOrder  Int       @default(0) @map("sort_order") @db.SmallInt
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@map("custom_fields")
}

model CaseRiskScore {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId      String   @map("case_id") @db.Uuid
  score       Decimal  @db.Decimal(5, 2)
  factors     Json?    @db.JsonB
  calculatedAt DateTime @default(now()) @map("calculated_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  case Case @relation(fields: [caseId], references: [id])

  @@map("case_risk_scores")
}

model LawyerPerformanceMetric {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String   @map("user_id") @db.Uuid
  periodType           String   @map("period_type") @db.VarChar(16)
  periodStart          DateTime @map("period_start") @db.Date
  periodEnd            DateTime @map("period_end") @db.Date
  casesClosed          Int      @default(0) @map("cases_closed")
  revenueBilled        Decimal  @default(0) @map("revenue_billed") @db.Decimal(18, 2)
  revenueCollected     Decimal  @default(0) @map("revenue_collected") @db.Decimal(18, 2)
  utilizationPct       Decimal? @map("utilization_pct") @db.Decimal(5, 2)
  avgCaseDurationDays  Int?     @map("avg_case_duration_days")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, periodType, periodStart])
  @@map("lawyer_performance_metrics")
}

model AuditLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firmId    String?   @map("firm_id") @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  action    String    @db.VarChar(64)
  entity    String    @db.VarChar(64)
  entityId  String?   @map("entity_id") @db.Uuid
  details   Json?     @db.JsonB
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("audit_logs")
}

// --- Client Portal: secure messaging per case ---
model CaseMessage {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId        String   @map("case_id") @db.Uuid
  senderId      String   @map("sender_id") @db.Uuid
  body          String   @db.Text
  attachmentUrl String?  @map("attachment_url") @db.VarChar(2048)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  case_ Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("case_messages")
}

// --- Client Portal: approval requests (document / fee_proposal / invoice) ---
model ApprovalRequest {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId       String    @map("case_id") @db.Uuid
  clientId     String    @map("client_id") @db.Uuid
  type         String    @db.VarChar(32) // document | fee_proposal | invoice
  entityId     String    @map("entity_id") @db.Uuid
  status       String    @default("pending") @db.VarChar(32) // pending | approved | rejected
  requestedBy  String?   @map("requested_by") @db.Uuid
  requestedAt  DateTime  @default(now()) @map("requested_at") @db.Timestamptz(6)
  respondedAt  DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  case_ Case  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("approval_requests")
}

// --- W9: Notification rules (event → channel) ---
model NotificationRule {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventType  String   @map("event_type") @db.VarChar(64)
  channel    String   @db.VarChar(32) // in_app | push | email
  targetType String   @map("target_type") @db.VarChar(32) // role | user
  targetId   String   @map("target_id") @db.Uuid
  caseId     String?  @map("case_id") @db.Uuid
  isActive   Boolean  @default(true) @map("is_active") @db.Boolean
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("notification_rules")
}

// --- W9: User notification preferences ---
model UserNotificationPref {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @map("user_id") @db.Uuid
  muteCaseIds     Json?    @map("mute_case_ids") @db.JsonB
  quietHoursStart String?  @map("quiet_hours_start") @db.VarChar(5)
  quietHoursEnd   String?  @map("quiet_hours_end") @db.VarChar(5)
  dailyDigest     Boolean  @default(false) @map("daily_digest") @db.Boolean
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_prefs")
}
